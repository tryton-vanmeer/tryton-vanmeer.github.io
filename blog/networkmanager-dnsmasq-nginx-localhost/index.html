<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  
  <link rel="stylesheet" href="https://www.trytonlux.ca/style.1ff68954d8536ed7f531220dcab2a50180fbdb96633cf6426e52f01bef149ffc.css" integrity="sha256-H/aJVNhTbtf1MSINyrKlAYD725ZjPPZCblLwG&#43;8Un/w=" media="screen">
  <title>NetworkManager dnsmasq - NGINX &#43; Localhost</title>
</head>

<body>
  
<script src="https://www.trytonlux.ca/js/navbar.f17a2bc3e918c7f28c28787fae1422f9857775bc06773b6ab0df5d8b9eaca877.js" integrity="sha256-8Xorw&#43;kYx/KMKHh/rhQi&#43;YV3dbwGdztqsN9di56sqHc="></script>

<nav class="navbar" role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="title" href="https://www.trytonlux.ca/">
      <span class="is-family-monospace has-text-danger">ƒ</span> Tryton
    </a>

    <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  </div>
  <div id="navMenu" class="navbar-menu is-shadowless">
    <div class="navbar-end">
      
      
      
      <span class="navbar-item ">
        <a href="/about/">About</a>
      </span>
      
      
      <span class="navbar-item ">
        <a href="/blog/">Blog</a>
      </span>
      
    </div>
  </div>
</nav>


  <main>
    



<section class="has-text-centered">
  <p class="title">
    NetworkManager dnsmasq - NGINX &#43; Localhost
  </p>
  <p class="subtitle ">
    Jan 1, 2021
  </p>
</section>

<section class="section">
  <div id="blog-content" class="container content">
    <p>This post serves as an overview of my configs for using domains with my local NGINX instance with SSL/HTTPS.</p>
<h1 id="forward-dns-requests-to-localhost">Forward DNS requests to localhost</h1>
<p>Create a dnsmasq conf:</p>
<p><strong>/etc/NetworkManager/dnsmasq.d/lh.conf</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">address</span><span class="o">=</span><span class="s">/lh/127.0.0.1</span>
</span></span></code></pre></div><p>Accessing <strong>domain</strong>.lh will be forwarded to localhost for NGINX to handle.</p>
<h1 id="setup-a-trusted-ssl-certificate">Setup a Trusted SSL Certificate</h1>
<p>I use a self-signed cert so that my localhost pages get a nice <strong>Connection secure</strong> padlock.</p>
<p>Create <code>/etc/nginx/ssl</code></p>
<h2 id="openssl-config">OpenSSL Config</h2>
<p><strong>lh.cnf</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[req]</span>
</span></span><span class="line"><span class="cl"><span class="na">default_bits</span> <span class="o">=</span> <span class="s">2048</span>
</span></span><span class="line"><span class="cl"><span class="na">distinguished_name</span> <span class="o">=</span> <span class="s">req_distinguished_name</span>
</span></span><span class="line"><span class="cl"><span class="na">prompt</span> <span class="o">=</span> <span class="s">no</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[req_distinguished_name]</span>
</span></span><span class="line"><span class="cl"><span class="na">C</span> <span class="o">=</span> <span class="s">CA</span>
</span></span><span class="line"><span class="cl"><span class="na">ST</span> <span class="o">=</span> <span class="s">Ontario</span>
</span></span><span class="line"><span class="cl"><span class="na">L</span> <span class="o">=</span> <span class="s">Ottawa</span>
</span></span><span class="line"><span class="cl"><span class="na">O</span> <span class="o">=</span> <span class="s">Localhost CA</span>
</span></span><span class="line"><span class="cl"><span class="na">OU</span> <span class="o">=</span> <span class="s">Development</span>
</span></span><span class="line"><span class="cl"><span class="na">CN</span> <span class="o">=</span> <span class="s">lh</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[v3_ca]</span>
</span></span><span class="line"><span class="cl"><span class="na">subjectAltName</span> <span class="o">=</span> <span class="s">@alt_names</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[alt_names]</span>
</span></span><span class="line"><span class="cl"><span class="na">DNS.1</span> <span class="o">=</span> <span class="s">hugo.lh</span>
</span></span><span class="line"><span class="cl"><span class="na">DNS.2</span> <span class="o">=</span> <span class="s">startpage.lh</span>
</span></span></code></pre></div><p>This alt_names contains all the subdomains you&rsquo;d like to use and be valid for this cert.</p>
<h2 id="root-certification-authority">Root Certification Authority</h2>
<p>I create a RootCA for signing my cert. This RootCA can later be added to the system so that Firefox automatically trusts the cert without having to accept it manually.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Create the private key</span>
</span></span><span class="line"><span class="cl">$ sudo openssl genrsa -out /etc/nginx/ssl/rootCA.key <span class="m">2048</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the PEM cert</span>
</span></span><span class="line"><span class="cl">$ sudo openssl req -x509 -new -nodes -key /etc/nginx/ssl/rootCA.key -sha256 -days <span class="m">3650</span> -out /etc/nginx/ssl/rootCA.pem
</span></span></code></pre></div><h2 id="ssl-certificates">SSL Certificates</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Create private key and CSR key</span>
</span></span><span class="line"><span class="cl">$ sudo openssl req -new -sha256 -nodes -newkey rsa:2048 -keyout /etc/nginx/ssl/lh.key -out /etc/nginx/ssl/ lh.csr -config lh.cnf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create cert using rootCA</span>
</span></span><span class="line"><span class="cl">$ sudo openssl x509 -req -in /etc/nginx/ssl/lh.csr -CA /etc/nginx/ssl/rootCA.pem -CAkey /etc/nginx/ssl/rootCA.key -CAcreateserial -out /etc/nginx/ssl/lh.crt -sha256 -days <span class="m">3650</span> -extfile lh.cnf -extensions v3_ca
</span></span></code></pre></div><h2 id="adding-trusted-ca-to-system">Adding Trusted CA to System</h2>
<p>On Arch Linux or Fedora, p11-kit can be used to add the RootCA system-wide.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo trust anchor --store /etc/nginx/ssl/rootCA.pem
</span></span></code></pre></div><h1 id="nginx">NGINX</h1>
<p>Create the initial NGINX config.</p>
<p><strong>/etc/nginx/nginx.conf</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">worker_processes</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">events</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">worker_connections</span> <span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">http</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">include</span> <span class="s">mime.types</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">default_type</span> <span class="s">application/octet-stream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">sendfile</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">keepalive_timeout</span> <span class="mi">65</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="ssl">SSL</h2>
<p>Configure NGINX to use SSL and redirect http → https.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">http</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">ssl_certificate</span> <span class="s">ssl/lh.crt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">ssl_certificate_key</span> <span class="s">ssl/lh.key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">server</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span> <span class="s">_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">return</span> <span class="mi">301</span> <span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="proxy-config">Proxy Config</h2>
<p>Common proxy config to be included.</p>
<p><strong>/etc/nginx/proxy.conf</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
</span></span></code></pre></div><h2 id="startpage">Startpage</h2>
<p>I use NGINX to host my Startpage locally at startpage.lh.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">http</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">server</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span> <span class="s">startpage.lh</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">root</span> <span class="s">/home/tryton-vanmeer/Code/Startpage/</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="hugo">Hugo</h2>
<p>I use hugo.lh to access hugo&rsquo;s server while developing hugo websites.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">http</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">server</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span> <span class="s">hugo.lh</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_pass</span> <span class="s">http://localhost:1313</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kn">include</span> <span class="s">proxy.conf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/livereload</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_pass</span> <span class="s">http://localhost:1313</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kn">include</span> <span class="s">proxy.conf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_set_header</span> <span class="s">Upgrade</span> <span class="nv">$http_upgrade</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_set_header</span> <span class="s">Connection</span> <span class="s">&#34;Upgrade&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And I run hugo as such: <code>hugo serve --baseURL http://hugo.lh --appendPort=false --liveReloadPort=443 --buildDrafts</code></p>

  </div>
</section>


  </main>

  <footer class="footer has-text-centered">
  <div>
    © Tryton Lux
    · <span class="icon"><i class="fas fa-font"></i></span>
    <a title="Content" href="https://creativecommons.org/licenses/by-sa/4.0/">
      CC BY-SA 4.0
    </a>
    · <span class="icon"><i class="fas fa-code"></i></span>
    <a title="Code" href="https://github.com/tryton-vanmeer/tryton-vanmeer.github.io">
      GPLv3
    </a>
  </div>

  <div>
    <a href="https://github.com/tryton-vanmeer" class="icon is-large">
      <i class="fab fa-2x fa-github"></i>
    </a>
    <a href="mailto:hello@tryton.thelux.family" class="icon is-large">
      <i class="fas fa-2x fa-envelope"></i>
    </a>
  </div>
</footer>

</body>

</html>
